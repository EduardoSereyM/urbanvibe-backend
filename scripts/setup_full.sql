-- ============================================================================
-- 1. CONFIGURACI√ìN DE CATEGOR√çAS (Selectores)
-- ============================================================================
-- Crear tabla de categor√≠as si no existe
CREATE TABLE IF NOT EXISTS public.categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT NOT NULL UNIQUE,
    icon TEXT, -- Emoji o nombre de icono
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insertar datos iniciales (Seed Data)
INSERT INTO public.categories (name, slug, icon) VALUES
    ('Restaurante', 'restaurante', 'üçΩÔ∏è'),
    ('Bar / Pub', 'bar-pub', 'üçª'),
    ('Cafeter√≠a', 'cafeteria', '‚òï'),
    ('Discoteca', 'discoteca', 'üíÉ'),
    ('Evento', 'evento', 'üé´'),
    ('Parque / Aire Libre', 'parque', 'üå≥'),
    ('Museo / Cultura', 'cultura', 'üèõÔ∏è'),
    ('Tienda', 'tienda', 'üõçÔ∏è')
ON CONFLICT (slug) DO NOTHING;

-- Habilitar RLS para categor√≠as (Lectura p√∫blica)
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Categor√≠as visibles para todos" ON public.categories;
CREATE POLICY "Categor√≠as visibles para todos" 
ON public.categories FOR SELECT 
USING (true);

-- ============================================================================
-- 2. TABLA DE LOCALES (Venues)
-- ============================================================================
-- Asegurar que la extensi√≥n PostGIS est√° habilitada
CREATE EXTENSION IF NOT EXISTS postgis SCHEMA extensions;

-- Nota: Si la tabla ya existe, estos comandos IF NOT EXISTS no modificar√°n la estructura.
-- Se recomienda revisar si se necesita ALTER TABLE para columnas existentes que cambian de tipo.

CREATE TABLE IF NOT EXISTS public.venues (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- Info B√°sica
    name TEXT NOT NULL,
    legal_name TEXT,
    slogan TEXT,
    overview TEXT,
    category_id BIGINT REFERENCES public.categories(id),
    
    -- Ubicaci√≥n
    address_street TEXT,
    address_number TEXT,
    city TEXT,
    region_state TEXT,
    country_code VARCHAR(2) DEFAULT 'CL',
    address_display TEXT, -- Direcci√≥n completa formateada
    location GEOGRAPHY(POINT, 4326), -- Para mapas y b√∫squedas
    
    -- Media
    logo_url TEXT,
    cover_image_urls TEXT[], -- Array de URLs
    
    -- Detalles
    price_tier SMALLINT CHECK (price_tier BETWEEN 1 AND 4),
    avg_price_min NUMERIC,
    avg_price_max NUMERIC,
    currency_code VARCHAR(3) DEFAULT 'CLP',
    
    -- Configuraci√≥n y Estado
    operational_status TEXT DEFAULT 'operational', -- operational, closed, temporarily_closed
    is_verified BOOLEAN DEFAULT false,
    is_featured BOOLEAN DEFAULT false,
    trust_tier TEXT DEFAULT 'standard', -- standard, bronze, silver, gold, platinum
    
    -- JSONB para flexibilidad futura
    opening_hours JSONB DEFAULT '{}'::jsonb,
    amenities JSONB DEFAULT '{}'::jsonb,
    payment_methods JSONB DEFAULT '{}'::jsonb,
    contact_info JSONB DEFAULT '{}'::jsonb, -- phone, email, website
    
    -- M√©tricas
    verified_visits_all_time BIGINT DEFAULT 0,
    rating_average NUMERIC(3, 2) DEFAULT 0,
    review_count INTEGER DEFAULT 0,
    
    -- Auditor√≠a
    owner_id UUID REFERENCES auth.users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- √çndices para b√∫squeda
CREATE INDEX IF NOT EXISTS venues_location_idx ON public.venues USING GIST (location);
CREATE INDEX IF NOT EXISTS venues_category_id_idx ON public.venues (category_id);

-- RLS para Venues
ALTER TABLE public.venues ENABLE ROW LEVEL SECURITY;

-- Lectura p√∫blica
DROP POLICY IF EXISTS "Locales visibles para todos" ON public.venues;
CREATE POLICY "Locales visibles para todos" 
ON public.venues FOR SELECT 
USING (true);

-- Escritura solo para Super Admins (o due√±os, seg√∫n l√≥gica futura)
-- Por ahora permitimos insert a usuarios autenticados para probar
DROP POLICY IF EXISTS "Usuarios autenticados pueden crear locales" ON public.venues;
CREATE POLICY "Usuarios autenticados pueden crear locales" 
ON public.venues FOR INSERT 
TO authenticated 
WITH CHECK (true);

DROP POLICY IF EXISTS "Usuarios pueden editar sus propios locales" ON public.venues;
CREATE POLICY "Usuarios pueden editar sus propios locales" 
ON public.venues FOR UPDATE
TO authenticated
USING (auth.uid() = owner_id);

-- ============================================================================
-- 3. INSTRUCCIONES PARA STORAGE (Im√°genes)
-- ============================================================================
/*
    IMPORTANTE: Supabase Storage requiere configuraci√≥n manual o v√≠a API, no solo SQL.
    
    Acci√≥n Requerida en Dashboard:
    1. Ve a Storage -> New Bucket
    2. Nombre: 'venues-media'
    3. Public: ON
    
    Opcional (si se prefiere SQL en el editor de Supabase):
    INSERT INTO storage.buckets (id, name, public) VALUES ('venues-media', 'venues-media', true) ON CONFLICT DO NOTHING;
    
    Pol√≠ticas de Storage (Ejecutar en SQL Editor):
    -- Lectura p√∫blica
    CREATE POLICY "Im√°genes visibles para todos" ON storage.objects FOR SELECT USING ( bucket_id = 'venues-media' );
    
    -- Escritura autenticada
    CREATE POLICY "Usuarios autenticados pueden subir im√°genes" ON storage.objects FOR INSERT TO authenticated WITH CHECK ( bucket_id = 'venues-media' );
*/
